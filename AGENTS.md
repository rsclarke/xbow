# XBOW Go Client Library

Idiomatic Go client for the XBOW API, following [google/go-github](https://github.com/google/go-github) patterns.

## Commands

```bash
# Regenerate the low-level client from OpenAPI spec
go generate ./...

# Build and typecheck
go build ./...

# Run tests
go test ./...
```

## Project Structure

```
├── openapi-2026-02-01.json   # OpenAPI 3.1 spec (source of truth)
├── oapi-codegen-dd.yaml      # Code generator config
├── internal/
│   └── api/
│       ├── generate.go       # go:generate directive
│       └── xbow.gen.go       # Generated client (DO NOT EDIT)
├── client.go                 # Public Client with service accessors
├── types.go                  # Domain types (Assessment, Finding, etc.)
├── errors.go                 # Error types and wrapError()
├── pagination.go             # Generic pagination helpers
├── assessments.go            # AssessmentsService
├── assets.go                 # AssetsService (when implemented)
├── findings.go               # FindingsService (when implemented)
└── ...
```

## Architecture

1. **Generated client** (`internal/api/xbow.gen.go`) - Auto-generated by oapi-codegen-dd from the OpenAPI spec. Never edit directly.

2. **Public wrapper** (root package) - Idiomatic Go API that users import. Hides generated types behind clean domain types.

## Adding a New Service

When adding support for new API endpoints:

### 1. Check the OpenAPI spec AND generated code

**OpenAPI spec** (`openapi-2026-02-01.json`) - the source of truth for:
- Path patterns (e.g., `/api/v1/findings/{findingId}`)
- Request/response schemas and required fields
- Required headers (always `X-XBOW-API-Version`)
- Error response codes and their meanings

**Generated code** (`internal/api/xbow.gen.go`) - needed for:
- Exact function names (e.g., `GetAPIV1FindingsFindingID`)
- Request option types (e.g., `GetAPIV1FindingsFindingIDRequestOptions`)
- Response types (e.g., `GetAPIV1FindingsFindingIDResponse`)
- Header constant names (e.g., `api.N20260201`)
- OneOf union accessor methods (e.g., `AsGetAPIV1...OneOf_0()`)

Use grep to find relevant types:
```bash
grep -n "FindingID" internal/api/xbow.gen.go | head -20
grep -n "type.*Finding.*Response struct" internal/api/xbow.gen.go
```

### 2. Define domain types in `types.go`

```go
type Finding struct {
    ID          string       `json:"id"`
    Severity    string       `json:"severity"`
    // ... map all required fields from the spec
    CreatedAt   time.Time    `json:"createdAt"`
}
```

### 3. Create the service file (e.g., `findings.go`)

```go
type FindingsService struct {
    client *Client
}

func (s *FindingsService) Get(ctx context.Context, id string) (*Finding, error) {
    opts := &api.GetAPIV1FindingsFindingIDRequestOptions{
        PathParams: &api.GetAPIV1FindingsFindingIDPath{
            FindingID: id,
        },
        Header: &api.GetAPIV1FindingsFindingIDHeaders{
            XXBOWAPIVersion: api.N20260201,
        },
    }

    resp, err := s.client.raw.GetAPIV1FindingsFindingID(ctx, opts, s.client.authEditor())
    if err != nil {
        return nil, wrapError(err)
    }

    return findingFromResponse(resp), nil
}
```

### 4. Add conversion functions

Convert from generated types to domain types. Handle all fields including complex unions:

```go
func findingFromResponse(r *api.GetAPIV1FindingsFindingIDResponse) *Finding {
    return &Finding{
        ID:        r.ID,
        Severity:  string(r.Severity),
        CreatedAt: r.CreatedAt,
    }
}
```

### 5. Register the service in `client.go`

```go
type Client struct {
    raw    *api.Client
    apiKey string

    Assessments *AssessmentsService
    Findings    *FindingsService  // Add here
}

func NewClient(apiKey string, opts ...ClientOption) (*Client, error) {
    // ...
    c.Findings = &FindingsService{client: c}  // Initialize here
    return c, nil
}
```

### 6. For list endpoints, implement pagination

```go
func (s *FindingsService) ListByAsset(ctx context.Context, assetID string, opts *ListOptions) (*Page[Finding], error) {
    // ... fetch single page
}

func (s *FindingsService) AllByAsset(ctx context.Context, assetID string, opts *ListOptions) iter.Seq2[Finding, error] {
    return paginate(ctx, opts, func(ctx context.Context, pageOpts *ListOptions) (*Page[Finding], error) {
        return s.ListByAsset(ctx, assetID, pageOpts)
    })
}
```

## Conventions

### Error Handling

- Always wrap errors with `wrapError(err)` to convert generated errors to `*Error`
- The `wrapError` function extracts structured error codes from API responses
- Add nil-checks for request parameters that would panic if nil

### RecentEvents / OneOf Unions

The API uses oneOf unions for events. Each response type has its own generated types:
- `GetAPIV1AssessmentsAssessmentID_Response_RecentEvents_OneOf`
- `PostAPIV1AssessmentsAssessmentIDCancel_Response_RecentEvents_OneOf`
- etc.

Create a conversion function per response type:

```go
func convertRecentEventsFromGet(events api.GetAPIV1AssessmentsAssessmentID_Response_RecentEvents) []AssessmentEvent {
    result := make([]AssessmentEvent, 0, len(events))
    for _, e := range events {
        if e.GetAPIV1AssessmentsAssessmentID_Response_RecentEvents_OneOf == nil {
            continue
        }
        oneOf := e.GetAPIV1AssessmentsAssessmentID_Response_RecentEvents_OneOf

        // Try each variant
        if v, err := oneOf.AsGetAPIV1AssessmentsAssessmentID_Response_RecentEvents_OneOf_0(); err == nil {
            result = append(result, AssessmentEvent{Name: string(v.Name), Timestamp: v.Timestamp})
            continue
        }
        // ... handle other variants
    }
    return result
}
```

### API Version Header

All requests require the `X-XBOW-API-Version` header. Use the generated constants:
- `api.N20260201` for GET endpoints
- `api.PostAPIV1...HeaderXXBOWAPIVersionN20260201` for POST endpoints (naming varies)

### Pointer Helpers

Use `ptrValue[T]` to safely dereference optional pointer fields:

```go
NextCursor: ptrValue(r.NextCursor),
```

## Checklist for Complete Service Implementation

- [ ] All endpoints from OpenAPI spec are implemented
- [ ] Domain types defined in `types.go` with all required fields
- [ ] Conversion functions handle ALL response fields including:
  - [ ] `RecentEvents` (if present)
  - [ ] Nested objects
  - [ ] Optional fields (use pointers or zero values appropriately)
- [ ] List endpoints have both `List*` (single page) and `All*` (iterator) methods
- [ ] Nil-checks on request parameters
- [ ] Errors wrapped with `wrapError()`
- [ ] Service registered in `Client` struct and initialized in `NewClient`
- [ ] Code compiles: `go build ./...`
